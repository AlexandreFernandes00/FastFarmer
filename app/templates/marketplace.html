{% extends "base.html" %}
{% block title %}Marketplace · FastFarmer{% endblock %}
{% block content %}

<h2>Marketplace</h2>
<p style="color:#475569;margin-top:-.2rem">Browse equipment & services. Select a listing and request work for one of your fields.</p>

<!-- Filters -->
<div class="card" style="margin-top:.75rem;">
  <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
    <label>Search
      <input id="q" placeholder="Search title or description…" />
    </label>
    <label>Pricing unit
      <select id="unit">
        <option value="">Any</option>
        <option value="hour">per hour</option>
        <option value="day">per day</option>
        <option value="hectare">per hectare</option>
        <option value="km">per km</option>
        <option value="job">per job</option>
      </select>
    </label>
    <div style="align-self:end; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button class="btn" id="applyFilters">Apply</button>
      <button class="btn btn-outline" id="clearFilters">Clear</button>
    </div>
  </div>
</div>

<!-- Listings -->
<div class="card" style="margin-top:1rem;">
  <div id="grid" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap:1rem;">
    <p>Loading listings…</p>
  </div>
</div>

<div id="msg" class="result" hidden></div>

<!-- Request modal -->
<dialog id="requestDlg" class="card" style="max-width:560px;width:95%;">
  <form method="dialog" onsubmit="return false;" style="margin:0;">
    <h3>Request this listing</h3>
    <p id="selListingTitle" style="margin-top:-.25rem;color:#555;"></p>

    <div id="requestGate" class="result" style="margin:.75rem 0 .25rem 0; display:none;">
      You must be logged in as a <strong>client</strong> and have at least one field to request work.
      <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">
        <a class="btn btn-outline" href="/login">Login</a>
        <a class="btn" href="/register">Register</a>
        <a class="btn btn-outline" href="/fields">Add a field</a>
      </div>
    </div>

    <div id="requestForm" class="form" style="display:none;">
      <label>Choose your field
        <select id="req_field" required></select>
      </label>
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
        <label>Desired date/time
          <input id="req_date" type="datetime-local" />
        </label>
        <label>Time window
          <select id="req_window">
            <option value="">—</option>
            <option>morning</option>
            <option>afternoon</option>
            <option>evening</option>
            <option>flexible</option>
          </select>
        </label>
      </div>
      <label>Notes
        <textarea id="req_notes" rows="2" placeholder="Anything the provider should know…"></textarea>
      </label>
    </div>

    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem;">
      <button class="btn btn-outline" onclick="MM_closeRequest()">Cancel</button>
      <button class="btn" id="sendReqBtn" onclick="MM_submitRequest()" style="display:none;">Send request</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block page_scripts %}
<script>
/* ===== Marketplace (self-contained) ===== */
const API = "/api/v1";
let token = localStorage.getItem("token");
let me = null;
let listings = [];
let fields = [];
let selectedListing = null;

function authHeaders(){ return token ? {"Authorization":"Bearer " + token} : {}; }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function showMsg(type, text){
  const m = document.getElementById("msg");
  m.className = "result " + (type === "ok" ? "ok" : "error");
  m.hidden = false; m.textContent = text;
}

(async function MM_boot(){
  // Pre-fill search from ?q= and top bar
  const urlQ = new URLSearchParams(location.search).get("q") || "";
  const topBar = document.getElementById("globalQuery");
  if (topBar) topBar.value = urlQ;
  document.getElementById("q").value = urlQ;

  // Auth + client fields
  await MM_loadAuth();
  await MM_loadFields();

  // Listings (public, already includes pricing)
  await MM_loadListings();

  // Render + bind filters
  MM_render();
  document.getElementById("applyFilters").addEventListener("click", MM_render);
  document.getElementById("clearFilters").addEventListener("click", () => {
    document.getElementById("q").value = "";
    document.getElementById("unit").value = "";
    const u = new URL(location.href); u.searchParams.delete("q"); history.replaceState(null, "", u.toString());
    MM_render();
  });
})();

async function MM_loadAuth(){
  me = null;
  if (!token) return;
  try{
    const r = await fetch(`${API}/auth/me`, { headers: authHeaders() });
    if (!r.ok) throw 0;
    me = await r.json();
  }catch{
    localStorage.removeItem("token");
    token = null; me = null;
  }
}

async function MM_loadFields(){
  fields = [];
  if (!token || !me?.is_client) return;
  try{
    const r = await fetch(`${API}/fields/`, { headers: authHeaders() });
    fields = r.ok ? await r.json() : [];
  }catch{}
}

async function MM_loadListings(){
  try{
    // Use public endpoint, include pricing
    const url = new URL(`${location.origin}${API}/listings/public`);
    const q = (document.getElementById("q").value || "").trim();
    if (q) url.searchParams.set("q", q);
    url.searchParams.set("include_pricing", "true");

    const r = await fetch(url.toString());
    listings = r.ok ? await r.json() : [];
  }catch{ listings = []; }
}

/* ---------- Pricing rendering ---------- */
/* pricing model fields:
    owner_type, owner_id, unit, base_price, min_qty?,
    transport_flat_fee?, transport_per_km?, currency, surcharges?
*/
function formatPriceRule(p){
  const cur = p.currency || "EUR";
  const base = (p.base_price != null) ? `${Number(p.base_price).toLocaleString()} ${cur}` : "";
  const unit = p.unit ? ` / ${p.unit}` : "";
  const min  = (p.min_qty != null) ? ` (min ${p.min_qty})` : "";
  const parts = [];
  if (base) parts.push(base + unit + min);
  const tf = p.transport_flat_fee != null ? `flat ${p.transport_flat_fee} ${cur}` : null;
  const tkm = p.transport_per_km != null ? `${p.transport_per_km} ${cur}/km` : null;
  if (tf || tkm) parts.push(`transport: ${[tf, tkm].filter(Boolean).join(" + ")}`);
  return parts.join(" • ");
}

function summarizePrices(pricing){
  if (!Array.isArray(pricing) || pricing.length === 0) return "Ask for a quote";
  // prefer listing-level first, then machine-level; show up to 3 lines
  const sorted = pricing.slice().sort((a,b)=>{
    const aKey = (a.owner_type === "listing" ? 0 : 1);
    const bKey = (b.owner_type === "listing" ? 0 : 1);
    if (aKey !== bKey) return aKey - bKey;
    // then by unit
    return String(a.unit||"").localeCompare(String(b.unit||""));
  });
  return sorted.slice(0,3).map(formatPriceRule).join(" · ");
}

/* ---------- UI ---------- */
function MM_card(listing){
  const pricing = listing.pricing || [];
  const priceLine = summarizePrices(pricing);

  // Build optional expandable details for all price rules
  const detailsId = `pricing_${listing.id}`;
  const detailRows = pricing.map(p => `<li>${esc(formatPriceRule(p))}</li>`).join("");
  const hasMore = pricing.length > 3;

  return `
  <div class="card" style="display:flex;flex-direction:column;gap:.6rem;">
    <div>
      <div style="font-weight:600">${esc(listing.title)}</div>
      <div style="color:#555">${esc(listing.description ?? "")}</div>
    </div>
    <div style="font-size:.9rem;color:#1e293b">${esc(priceLine)}</div>

    ${pricing.length ? `
      <details id="${detailsId}" style="font-size:.9rem;">
        <summary class="btn btn-outline" style="padding:.35rem .6rem; display:inline-flex;">
          ${hasMore ? "See all pricing" : "Price details"}
        </summary>
        <ul style="margin:.5rem 0 0 1rem; padding:0; color:#334155;">
          ${detailRows}
        </ul>
      </details>
    ` : ``}

    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:auto;">
      <button class="btn" onclick='MM_openRequest(${JSON.stringify(listing)})'>Request this</button>
    </div>
  </div>`;
}

function MM_render(){
  // Re-load listings so server search (?q=) applies
  MM_loadListings().then(() => {
    let rows = listings.slice();

    // Client-side refine by unit
    const unit = document.getElementById("unit").value;
    if (unit) {
      rows = rows.filter(l => Array.isArray(l.pricing) && l.pricing.some(p => p.unit === unit));
    }

    // Local text refine (in addition to server-side)
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    if (q) {
      rows = rows.filter(l =>
        (l.title||"").toLowerCase().includes(q) ||
        (l.description||"").toLowerCase().includes(q)
      );
    }

    const grid = document.getElementById("grid");
    grid.innerHTML = rows.length ? rows.map(MM_card).join("") : "<p>No listings match your filters.</p>";
  });
}

/* ---------- Request flow ---------- */
function MM_openRequest(listing){
  selectedListing = listing;

  document.getElementById("selListingTitle").textContent = listing.title || "";

  const gate = document.getElementById("requestGate");
  const form = document.getElementById("requestForm");
  const sendBtn = document.getElementById("sendReqBtn");
  const sel = document.getElementById("req_field");

  // Default: gate visible
  gate.style.display = "block";
  form.style.display = "none";
  sendBtn.style.display = "none";
  sel.innerHTML = "";

  // not logged in / not a client
  if (!me || !me.is_client) {
    document.getElementById("requestDlg").showModal();
    return;
  }

  // ensure fields
  const openWithForm = () => {
    if (!fields.length) {
      gate.style.display = "block";
      form.style.display = "none";
      sendBtn.style.display = "none";
    } else {
      gate.style.display = "none";
      form.style.display = "block";
      sendBtn.style.display = "inline-flex";
      sel.innerHTML = "";
      fields.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = `${f.name} (${Number(f.area_ha).toFixed(2)} ha)`;
        sel.appendChild(opt);
      });
    }
    document.getElementById("requestDlg").showModal();
  };

  if (!fields.length) {
    MM_loadFields().then(openWithForm);
  } else {
    openWithForm();
  }
}

function MM_closeRequest(){
  document.getElementById("requestDlg").close();
  selectedListing = null;
}

async function MM_submitRequest(){
  if (!selectedListing) return;

  const field_id = document.getElementById("req_field").value;
  if (!field_id) { showMsg("error", "Please choose a field."); return; }
  const desired_date = document.getElementById("req_date").value || null;
  const time_window  = document.getElementById("req_window").value || null;
  const notes        = (document.getElementById("req_notes").value || "").trim() || null;

  const payload = { listing_id: selectedListing.id, field_id, desired_date, time_window, notes };

  try{
    const r = await fetch(`${API}/requests/`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload)
    });
    if (!r.ok) {
      const e = await r.json().catch(()=>({detail:"Error"}));
      showMsg("error", e.detail || "Could not create request");
      return;
    }
    showMsg("ok", "Request sent. Providers can now quote.");
    MM_closeRequest();
  }catch{
    showMsg("error", "Network error creating request.");
  }
}
</script>
{% endblock %}
