{% extends "base.html" %}
{% block content %}
<h2>Marketplace</h2>

<!-- Gate -->
<div id="gate" class="card" hidden>
  <p>You need to be logged in as a <strong>client</strong> to request work.</p>
  <p>
    <a class="btn" href="/login">Login</a>
    <a class="btn btn-outline" href="/fields">Manage my fields</a>
  </p>
</div>

<!-- Filters -->
<section class="card" id="filters" hidden>
  <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
    <label>Search
      <input id="q" placeholder="Search title, machine..." oninput="render()" />
    </label>
    <label>Status
      <select id="status" onchange="render()">
        <option value="">Active only</option>
        <option value="all">All</option>
      </select>
    </label>
    <label>Unit (pricing)
      <select id="unit" onchange="render()">
        <option value="">Any</option>
        <option value="hour">per hour</option>
        <option value="hectare">per hectare</option>
        <option value="km">per km</option>
        <option value="job">per job</option>
      </select>
    </label>
  </div>
</section>

<!-- Listings -->
<section class="card" id="content" hidden>
  <div id="grid" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:1rem;"></div>
</section>

<div id="msg" class="result" hidden></div>

<!-- Request modal -->
<dialog id="requestDlg" class="card" style="max-width:560px;width:95%;">
  <form method="dialog" onsubmit="return false;" style="margin:0;">
    <h3>Request this listing</h3>
    <p id="selListingTitle" style="margin-top:-.25rem;color:#555;"></p>
    <div class="form">
      <label>Choose your field
        <select id="req_field" required></select>
      </label>
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
        <label>Desired date/time
          <input id="req_date" type="datetime-local" />
        </label>
        <label>Time window
          <select id="req_window">
            <option value="">—</option>
            <option>morning</option>
            <option>afternoon</option>
            <option>evening</option>
            <option>flexible</option>
          </select>
        </label>
      </div>
      <label>Notes
        <textarea id="req_notes" rows="2" placeholder="Anything the provider should know…"></textarea>
      </label>
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn btn-outline" onclick="closeRequest()">Cancel</button>
      <button class="btn" onclick="submitRequest()">Send request</button>
    </div>
  </form>
</dialog>

<script>
const API="/api/v1";
let token = localStorage.getItem("token");
let me=null, fields=[], listings=[], pricingByMachine=new Map();
let selectedListing=null;

function authHeaders(){ return token ? {"Authorization":"Bearer "+token} : {}; }
function show(el, yes=true){ el.hidden=!yes; }
function msgOk(t){ const m=document.getElementById("msg"); m.className="result ok"; m.hidden=false; m.textContent=t; }
function msgErr(t){ const m=document.getElementById("msg"); m.className="result error"; m.hidden=false; m.textContent=t; }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

(async function init(){
  // auth & role
  me = await fetch(`${API}/auth/me`, { headers: authHeaders() }).then(r=>r.ok?r.json():null);
  if (!me || !me.is_client) { show(document.getElementById("gate"), true); return; }
  show(document.getElementById("filters"), true);
  show(document.getElementById("content"), true);

  await Promise.all([loadFields(), loadListings()]);
  render();
})();

async function loadFields(){
  const r = await fetch(`${API}/fields/`, { headers: authHeaders() });
  if (!r.ok) { fields=[]; return; }
  fields = await r.json();
}

async function loadListings(){
  // Load listings and pricing rules (so cards can show indicative price)
  const [lr, pr] = await Promise.all([
    fetch(`${API}/listings/`, { headers: authHeaders() }),
    fetch(`${API}/pricing/`,  { headers: authHeaders() })
  ]);
  listings = lr.ok ? await lr.json() : [];
  const pricing = pr.ok ? await pr.json() : [];
  pricingByMachine = new Map();
  pricing.forEach(p=>{
    if(p.owner_type === "machine"){
      const arr = pricingByMachine.get(p.owner_id) || [];
      arr.push(p); pricingByMachine.set(p.owner_id, arr);
    }
  });
}

function card(listing){
  const rules = pricingByMachine.get(listing.ref_machine_id) || [];
  const unit = document.getElementById("unit").value;
  const visibleRules = unit ? rules.filter(r => r.unit === unit) : rules;
  const priceText = visibleRules.length
    ? visibleRules.map(r => `${r.base_price} ${r.currency} / ${r.unit}`).join(" · ")
    : "Ask for a quote";

  return `
  <div class="card" style="display:flex;flex-direction:column;gap:.5rem;">
    <div>
      <div style="font-weight:600">${esc(listing.title)}</div>
      <div style="color:#555">${esc(listing.description ?? "")}</div>
    </div>
    <div style="font-size:.9rem;color:#222">${esc(priceText)}</div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:auto;">
      <button class="btn" onclick='openRequest(${JSON.stringify(listing)})'>Request this</button>
    </div>
  </div>`;
}

function render(){
  const q = document.getElementById("q").value.toLowerCase().trim();
  const status = document.getElementById("status").value; // "" or "all"
  let rows = listings.slice();
  if (status !== "all") rows = rows.filter(l => (l.status || "active") === "active");
  if (q) rows = rows.filter(l => (l.title||"").toLowerCase().includes(q) || (l.description||"").toLowerCase().includes(q));
  // if unit filter selected, hide cards with no matching pricing rule
  const unit = document.getElementById("unit").value;
  if (unit) rows = rows.filter(l => {
    const rules = pricingByMachine.get(l.ref_machine_id) || [];
    return rules.some(r => r.unit === unit);
  });
  const grid = document.getElementById("grid");
  grid.innerHTML = rows.length ? rows.map(card).join("") : "<p>No listings match your filters.</p>";
}

function openRequest(listing){
  selectedListing = listing;
  document.getElementById("selListingTitle").textContent = listing.title;
  const sel = document.getElementById("req_field");
  sel.innerHTML = "";
  if (!fields.length) {
    const opt = document.createElement("option");
    opt.value=""; opt.textContent="(No fields yet — go add one)";
    sel.appendChild(opt);
  } else {
    fields.forEach(f=>{
      const opt = document.createElement("option");
      opt.value = f.id;
      opt.textContent = `${f.name} (${Number(f.area_ha).toFixed(2)} ha)`;
      sel.appendChild(opt);
    });
  }
  document.getElementById("requestDlg").showModal();
}

function closeRequest(){
  document.getElementById("requestDlg").close();
  selectedListing = null;
}

async function submitRequest(){
  if (!selectedListing) return;
  const field_id = document.getElementById("req_field").value;
  if (!field_id) { msgErr("Please choose a field."); return; }
  const desired_date = document.getElementById("req_date").value || null;
  const time_window  = document.getElementById("req_window").value || null;
  const notes        = (document.getElementById("req_notes").value || "").trim() || null;

  const payload = {
    listing_id: selectedListing.id,
    field_id,
    desired_date,
    time_window,
    notes
  };

  const r = await fetch(`${API}/requests/`, {
    method: "POST",
    headers: { "Content-Type":"application/json", ...authHeaders() },
    body: JSON.stringify(payload)
  });
  if (!r.ok) {
    const e = await r.json().catch(()=>({detail:"Error"}));
    msgErr(e.detail || "Could not create request");
    return;
  }
  msgOk("Request sent. Providers can now quote.");
  closeRequest();
}
</script>
{% endblock %}
