{% extends "base.html" %}
{% block title %}Request Job · FastFarmer{% endblock %}
{% block content %}

<h2>Request Job</h2>
<p style="color:#475569;margin-top:-.25rem;">Choose your field and send a request to the provider.</p>

<div id="msg" class="result" hidden></div>

<div id="summary" class="card" style="margin-top:.75rem;">
  <div><strong>Listing:</strong> <span id="ls_title">—</span></div>
  <div style="margin-top:.25rem; color:#475569;" id="ls_price">—</div>
</div>

<form class="card" style="margin-top:1rem; display:flex; flex-direction:column; gap:.75rem;" onsubmit="event.preventDefault(); submitRequest();">
  <input id="listing_id" type="hidden"/>

  <label>Field
    <select id="field_id" required>
      <option value="">— Select one of your fields —</option>
    </select>
  </label>

  <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
    <label>Desired date
      <input id="desired_date" type="datetime-local" />
    </label>

    <label>Time window
      <select id="time_window">
        <option value="">— optional —</option>
        <option value="morning">morning</option>
        <option value="afternoon">afternoon</option>
        <option value="evening">evening</option>
      </select>
    </label>
  </div>

  <label>Notes
    <textarea id="notes" rows="3" placeholder="Anything the provider should know (gate access, crop condition, etc.)"></textarea>
  </label>

  <div style="display:flex; gap:.5rem; justify-content:flex-end;">
    <a class="btn btn-outline" href="/marketplace">Cancel</a>
    <button class="btn" type="submit">Send request</button>
  </div>
</form>
<!-- In the row renderer, add a button to view quotes -->
<td style="text-align:right; padding:.55rem;border-bottom:1px solid #eef;">
  <button class="btn btn-outline" onclick='viewQuotes("${r.id}")'>Quotes</button>
  <a class="btn btn-outline" href="/request?listing_id=${r.listing_id}">Re-request</a>
</td>

{% endblock %}

{% block page_scripts %}
<script>
const API = "/api/v1";
let token = localStorage.getItem("token");
function authHeaders(){ return token ? {"Authorization":"Bearer " + token} : {}; }
function showMsg(type, text){
  const m = document.getElementById("msg");
  m.className = "result " + (type === "ok" ? "ok" : "error");
  m.hidden = false; m.textContent = text;
}
function esc(s){ return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let listingId = null;

(async function boot(){
  const params = new URLSearchParams(location.search);
  listingId = params.get("listing_id");
  if (!listingId){ showMsg("error","Missing listing_id"); return; }
  document.getElementById("listing_id").value = listingId;

  await loadListing();
  await loadFields();
})();

async function loadListing(){
  try{
    const r = await fetch(`${API}/listings/public/${listingId}?include_pricing=true`, { headers: authHeaders() });
    if (!r.ok) throw new Error("Listing not found");
    const x = await r.json();
    document.getElementById("ls_title").textContent = x.title || "—";
    document.getElementById("ls_price").textContent = x.prices_text || "Ask for a quote";
  }catch(e){
    showMsg("error", e.message || "Could not load listing.");
  }
}

async function loadFields(){
  const sel = document.getElementById("field_id");
  sel.innerHTML = `<option value="">— Select one of your fields —</option>`;
  try{
    // try /fields/me first; fallback to /fields/
    let r = await fetch(`${API}/fields/me`, { headers: authHeaders() });
    if (!r.ok) r = await fetch(`${API}/fields/`, { headers: authHeaders() });
    if (!r.ok) throw new Error("Failed to load your fields");
    const arr = await r.json();
    if (!Array.isArray(arr) || !arr.length) {
      showMsg("error","You have no fields yet. Add fields first.");
      return;
    }
    arr.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||"")));
    for (const f of arr){
      const opt = document.createElement("option");
      opt.value = f.id;
      const area = (f.area_ha ?? f.area_ha_cached);
      opt.textContent = [f.name, area ? `${area} ha` : null].filter(Boolean).join(" · ");
      sel.appendChild(opt);
    }
  }catch(e){
    showMsg("error", e.message || "Could not load your fields.");
  }
}

async function submitRequest(){
  const field_id = document.getElementById("field_id").value;
  const desired_date_raw = document.getElementById("desired_date").value; // local time
  const time_window = document.getElementById("time_window").value || null;
  const notes = document.getElementById("notes").value || null;

  if (!token){ showMsg("error","Please log in as a client to request a job."); return; }
  if (!field_id){ showMsg("error","Please select a field."); return; }

  // Convert to ISO with timezone if provided
  let desired_date = null;
  if (desired_date_raw){
    const dt = new Date(desired_date_raw);
    desired_date = dt.toISOString(); // backend expects TIMESTAMPTZ-compatible
  }

  const payload = { listing_id: listingId, field_id, desired_date, time_window, notes };

  try{
    const r = await fetch(`${API}/requests`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload)
    });
    if (!r.ok) {
      const e = await r.json().catch(()=>({detail:"Request failed"}));
      throw new Error(e.detail || "Request failed");
    }
    showMsg("ok", "Request sent! You can track it in your dashboard.");
    // optional redirect after a short delay
    setTimeout(()=> location.href = "/dashboard", 900);
  }catch(e){
    showMsg("error", e.message || "Could not send request.");
  }
}
async function viewQuotes(requestId){
  try{
    const r = await fetch(`/api/v1/quotes/for-request/${requestId}`, { headers: ah() });
    if (!r.ok) throw new Error("Failed to load quotes");
    const qs = await r.json();
    if (!qs.length){ msg("error","No quotes yet for this request."); return; }

    // Simple chooser dialog
    const html = qs.map(q => {
      const items = (q.items||[]).map(it => `- ${esc(it.description)}: ${it.line_total} ${q.currency}`).join("<br>");
      return `
        <div class="card" style="margin:.5rem 0;">
          <div><strong>Total:</strong> ${q.total} ${q.currency} · <strong>Status:</strong> ${q.status}</div>
          <div style="color:#475569; margin-top:.25rem;">${items}</div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
            ${q.status === "offered" ? `<button class="btn" onclick='acceptQuote("${q.id}")'>Accept</button>` : ``}
          </div>
        </div>
      `;
    }).join("");

    const container = document.createElement("div");
    container.innerHTML = `
      <dialog class="card" style="max-width:680px;width:95%;">
        <h3>Quotes for request</h3>
        <div style="max-height:60vh; overflow:auto; margin-top:.5rem;">${html}</div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem;">
          <button class="btn btn-outline" onclick="this.closest('dialog').close()">Close</button>
        </div>
      </dialog>`;
    document.body.appendChild(container);
    const dlg = container.querySelector("dialog");
    dlg.addEventListener("close", ()=> container.remove());
    dlg.showModal();
  }catch(e){
    msg("error", e.message || "Could not load quotes.");
  }
}

async function acceptQuote(quoteId){
  try{
    const r = await fetch(`/api/v1/quotes/${quoteId}/accept`, { method:"POST", headers: ah() });
    if (!r.ok){
      const e = await r.json().catch(()=>({detail:"Failed to accept"}));
      msg("error", e.detail || "Failed to accept");
      return;
    }
    msg("ok","Quote accepted.");
    // refresh the table
    await loadMine(); await hydrateListings(); render();
    // close any open dialog
    const openDlg = document.querySelector("dialog[open]"); if (openDlg) openDlg.close();
  }catch{
    msg("error","Network error.");
  }
}

</script>
{% endblock %}
