<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{% block title %}FastFarmer{% endblock %}</title>
  <style>
    :root{
      --bg:#f7f9fc; --text:#1e2430; --muted:#5b6577; --brand:#167e56;
      --panel:#ffffff; --border:#e3e8f0; --hover:#f0f4f9;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text); background:var(--bg);}
    a{color:var(--brand); text-decoration:none}
    a:hover{opacity:.9}
    .btn{
      background:var(--brand); color:#fff; border:none; padding:.55rem .85rem; border-radius:.6rem; cursor:pointer; font-weight:600;
    }
    .btn-outline{
      background:#fff; color:var(--text); border:1px solid var(--border); padding:.5rem .85rem; border-radius:.6rem; cursor:pointer;
    }
    input, select, textarea{
      width:100%; background:#fff; border:1px solid var(--border); color:var(--text); border-radius:.5rem; padding:.55rem .65rem;
    }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:.9rem; padding:1rem;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .grid{display:grid; gap:.75rem}
    .form label{display:block; font-size:.92rem; color:#2d3648}
    .form label input, .form label select, .form label textarea{margin-top:.35rem}
    .result{margin-top:1rem; padding:.6rem .75rem; border-radius:.5rem; border:1px solid var(--border)}
    .result.ok{background:#e9f7ef; color:#0a6e43; border-color:#c8ead7}
    .result.error{background:#fff1f2; color:#9f1239; border-color:#ffe4e6}

    /* Layout */
    .topbar{
      position:sticky; top:0; z-index:20; background:var(--panel); border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:.75rem; padding:.6rem .9rem;
    }
    .brand{font-weight:800; color:var(--text);}
    .spacer{flex:1}
    .search{display:flex; align-items:center; gap:.5rem; max-width:700px; flex:1; background:#fff; border:1px solid var(--border); border-radius:.6rem; padding:.35rem .55rem;}
    .search input{border:none; outline:none; background:transparent}
    .content{padding:1rem; max-width:1200px; margin:0 auto}

    /* Burger menu */
    .burger{position:relative}
    .burger-btn{
      display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .65rem; border:1px solid var(--border); border-radius:.6rem; background:#fff; cursor:pointer;
    }
    .burger-menu{
      position:absolute; top:calc(100% + .4rem); left:0; min-width:240px; background:#fff; border:1px solid var(--border);
      border-radius:.6rem; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:.4rem; display:none;
    }
    .burger.open .burger-menu{display:block}
    .menu-section{padding:.35rem .35rem .2rem; font-size:.72rem; text-transform:uppercase; letter-spacing:.06em; color:#6b7280}
    .menu a{
      display:flex; align-items:center; gap:.5rem; color:var(--text); padding:.5rem .6rem; border-radius:.5rem;
    }
    .menu a:hover{background:var(--hover)}
    .active{background:var(--hover)}

    @media (max-width: 820px){
      .search{max-width:none}
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
  <header class="topbar">
    <div class="brand"><a href="/">FastFarmer</a></div>

    <a class="btn btn-outline" href="/dashboard">Dashboard</a>

    <form class="search" onsubmit="return globalSearch(event)">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M21.53 20.47l-4.66-4.66A7.94 7.94 0 0018 10a8 8 0 10-8 8 7.94 7.94 0 005.81-2.13l4.66 4.66a.75.75 0 001.06-1.06zM4.5 10a5.5 5.5 0 1111 0 5.5 5.5 0 01-11 0z"/></svg>
      <input id="globalQuery" placeholder="Search listingsâ€¦"/>
      <button class="btn" type="submit">Search</button>
    </form>

    <div class="spacer"></div>

    <!-- Burger -->
    <div id="burger" class="burger">
      <button class="burger-btn" type="button" onclick="toggleBurger()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18M3 12h18M3 18h18"/></svg> Menu
      </button>
      <div class="burger-menu card">
        <div id="clientSection" hidden>
          <div class="menu-section">Client</div>
          <nav class="menu">
            <a href="/marketplace" data-match="^/marketplace">Marketplace</a>
            <a href="/fields" data-match="^/fields">My Fields</a>
            <a href="/requests" data-match="^/requests">My Requests</a>
          </nav>
        </div>
        <div id="providerSection" hidden>
          <div class="menu-section">Provider</div>
          <nav class="menu">
            <a href="/machines" data-match="^/machines">Machines</a>
            <a href="/listings" data-match="^/listings">Listings & Pricing</a>
            <a href="/inbox" data-match="^/inbox">Inbox (Requests)</a>
          </nav>
        </div>
        <div id="adminSection" hidden>
          <div class="menu-section">Admin</div>
          <nav class="menu">
            <a href="/admin" data-match="^/admin">Console</a>
          </nav>
        </div>
      </div>
    </div>

    <!-- Auth -->
    <div id="authBtns" style="margin-left:.5rem;">
      <a class="btn btn-outline" href="/login">Login</a>
      <a class="btn" href="/register">Register</a>
    </div>
  </header>

  <main class="content">
    {% block content %}{% endblock %}
  </main>

  <script>
    // --- Auth & menu logic (runs on every page) ---
    const API = "/api/v1";
    let token = localStorage.getItem("token");
    let me = null;

    document.addEventListener("DOMContentLoaded", () => {
      initBase();   // make sure this runs after DOM is ready
    });

    function toggleBurger(){
      const b = document.getElementById("burger");
      b.classList.toggle("open");
      // click outside to close
      if (b.classList.contains("open")) {
        const onDocClick = (e) => {
          if (!b.contains(e.target)) {
            b.classList.remove("open");
            document.removeEventListener("click", onDocClick);
          }
        };
        setTimeout(()=>document.addEventListener("click", onDocClick), 0);
      }
    }

    function globalSearch(e){
      e.preventDefault();
      const q = (document.getElementById("globalQuery").value || "").trim();
      const dest = q ? `/marketplace?q=${encodeURIComponent(q)}` : "/marketplace";
      window.location.href = dest;
      return false;
    }

    async function initBase(){
      highlightActiveLinks();
      await loadAuth();        // ensure auth shown correctly on ALL pages
      renderMenus();
    }

    async function loadAuth(){
      const el = document.getElementById("authBtns");
      // default: logged out
      const showLoggedOut = () => {
        el.innerHTML = `
          <a class="btn btn-outline" href="/login">Login</a>
          <a class="btn" href="/register">Register</a>
        `;
      };

      if (!token) { showLoggedOut(); return; }
      try{
        const r = await fetch(`${API}/auth/me`, { headers: { "Authorization": "Bearer " + token } });
        if (!r.ok) throw 0;
        me = await r.json();
        el.innerHTML = `
          <span style="color:#475569; margin-right:.4rem;">Hi, ${escapeHtml(me.full_name || me.email)}</span>
          <button class="btn btn-outline" onclick="logout()">Logout</button>
        `;
      }catch{
        // bad/expired token
        localStorage.removeItem("token");
        token = null;
        me = null;
        showLoggedOut();
      }
    }

    function logout(){
      localStorage.removeItem("token");
      token = null;
      me = null;
      location.href = "/login";
    }

    function renderMenus(){
      // hide all sections by default
      document.getElementById("clientSection").hidden = true;
      document.getElementById("providerSection").hidden = true;
      document.getElementById("adminSection").hidden = true;

      if (!me) return;
      if (me.is_client)   document.getElementById("clientSection").hidden = false;
      if (me.is_provider) document.getElementById("providerSection").hidden = false;
      if (me.is_admin)    document.getElementById("adminSection").hidden = false;
    }

    function highlightActiveLinks(){
      const path = location.pathname;
      document.querySelectorAll('[data-match]').forEach(a => {
        const pat = a.getAttribute('data-match');
        try{
          if (new RegExp(pat).test(path)) a.classList.add('active');
        }catch{}
      });
    }

    function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  </script>

  {% block page_scripts %}{% endblock %}
</body>
</html>
