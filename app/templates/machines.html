{% extends "base.html" %}
{% block content %}
<h2>My Machines</h2>

<!-- Gate for unauthenticated / non-provider users -->
<div id="gate" class="card" hidden>
  <p>You must be logged in as a <strong>provider</strong> to manage machines.</p>
  <p>
    <a class="btn" href="/login">Login</a>
    <a class="btn btn-outline" href="/dashboard">Go to dashboard</a>
  </p>
</div>

<!-- Main content -->
<section id="content" hidden>
  <!-- Create -->
  <div class="card">
    <h3>Add a machine</h3>
    <form id="createForm" class="form" onsubmit="return createMachine(event)">
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
        <label>Category
          <select name="category_id" id="categorySelect">
            <option value="">—</option>
          </select>
        </label>
        <label>Make
          <input name="make" required />
        </label>
        <label>Model
          <input name="model" required />
        </label>
        <label>Year
          <input name="year" type="number" min="1950" max="2100" />
        </label>
        <label>Serial no.
          <input name="serial_no" />
        </label>
        <label>Power (hp)
          <input name="power_hp" type="number" step="0.01" oninput="syncKW(this,'power_kw')" />
        </label>
        <label>Power (kW)
          <input name="power_kw" type="number" step="0.01" />
        </label>
        <label>Working width (m)
          <input name="working_width_m" type="number" step="0.01" />
        </label>
        <label>Capacity per hour
          <input name="capacity_per_hour" type="number" step="0.01" />
        </label>
        <label>PTO hp
          <input name="pto_hp" type="number" step="0.01" />
        </label>
        <label>Transport width (m)
          <input name="transport_width_m" type="number" step="0.01" />
        </label>
        <label>Tire size
          <input name="tire_size" />
        </label>
        <label>Fuel type
          <input name="fuel_type" placeholder="Diesel, Electric…" />
        </label>
        <label>Hours meter
          <input name="hours_meter" type="number" step="0.01" />
        </label>
        <label>Road legal
          <select name="is_road_legal">
            <option value="">—</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </label>
        <label>Telemetry enabled
          <select name="telemetry_enabled">
            <option value="">—</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </label>
      </div>
      <label>Notes
        <textarea name="notes" rows="2" placeholder="Attachments, configs, maintenance notes…"></textarea>
      </label>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <button class="btn" type="submit">Create machine</button>
        <button class="btn btn-outline" type="button" onclick="loadMachines()">Refresh</button>
      </div>
    </form>
  </div>

  <!-- List -->
  <div class="card" style="margin-top:1rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">Your machines</h3>
      <div style="display:flex;gap:.5rem;">
        <input id="q" placeholder="Search make/model/serial…" oninput="filterList()" />
        <select id="statusFilter" onchange="filterList()">
          <option value="">All statuses</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="retired">Retired</option>
        </select>
      </div>
    </div>
    <div id="list" style="margin-top:.5rem;"></div>
  </div>
</section>

<div id="msg" class="result" hidden></div>

<!-- Edit modal -->
<dialog id="editDlg" class="card" style="max-width:900px;width:96%;">
  <form method="dialog" style="margin:0" onsubmit="return false;">
    <h3>Edit machine</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
      <label>Category
        <select id="edit_category_id"></select>
      </label>
      <label>Make
        <input id="edit_make" required />
      </label>
      <label>Model
        <input id="edit_model" required />
      </label>
      <label>Year
        <input id="edit_year" type="number" min="1950" max="2100" />
      </label>
      <label>Serial no.
        <input id="edit_serial_no" />
      </label>
      <label>Power (hp)
        <input id="edit_power_hp" type="number" step="0.01" oninput="syncKW(this,'edit_power_kw')" />
      </label>
      <label>Power (kW)
        <input id="edit_power_kw" type="number" step="0.01" />
      </label>
      <label>Working width (m)
        <input id="edit_working_width_m" type="number" step="0.01" />
      </label>
      <label>Capacity per hour
        <input id="edit_capacity_per_hour" type="number" step="0.01" />
      </label>
      <label>PTO hp
        <input id="edit_pto_hp" type="number" step="0.01" />
      </label>
      <label>Transport width (m)
        <input id="edit_transport_width_m" type="number" step="0.01" />
      </label>
      <label>Tire size
        <input id="edit_tire_size" />
      </label>
      <label>Fuel type
        <input id="edit_fuel_type" />
      </label>
      <label>Hours meter
        <input id="edit_hours_meter" type="number" step="0.01" />
      </label>
      <label>Road legal
        <select id="edit_is_road_legal">
          <option value="">—</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </label>
      <label>Telemetry enabled
        <select id="edit_telemetry_enabled">
          <option value="">—</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </label>
      <label>Status
        <select id="edit_status" required>
          <option value="active">active</option>
          <option value="paused">paused</option>
          <option value="retired">retired</option>
        </select>
      </label>
    </div>
    <label>Notes
      <textarea id="edit_notes" rows="2"></textarea>
    </label>

    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem;">
      <button class="btn btn-outline" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="submitEdit()">Save</button>
    </div>
  </form>
</dialog>

<script>
const API = "/api/v1";
let token = localStorage.getItem("token");
let allMachines = [];
let categories = [];
let editingId = null;

function authHeaders() {
  return token ? { "Authorization": "Bearer " + token } : {};
}
function show(el, yes=true){ el.hidden = !yes; }
function msgOk(t){ const m = document.getElementById("msg"); m.className="result ok"; m.hidden=false; m.textContent=t; }
function msgErr(t){ const m = document.getElementById("msg"); m.className="result error"; m.hidden=false; m.textContent=t; }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

(async function init() {
  // gate by auth + role
  if (!token) return show(document.getElementById("gate"), true);
  try {
    const meRes = await fetch(`${API}/auth/me`, { headers: authHeaders() });
    if (!meRes.ok) throw 0;
    const me = await meRes.json();
    if (!me.is_provider) return show(document.getElementById("gate"), true);
    show(document.getElementById("content"), true);
  } catch { return show(document.getElementById("gate"), true); }

  await loadCategories();
  await loadMachines();
})();

async function loadCategories() {
  const select = document.getElementById("categorySelect");
  const editSelect = document.getElementById("edit_category_id");
  [select, editSelect].forEach(s => s.innerHTML = `<option value="">—</option>`);

  try{
    const r = await fetch(`${API}/categories?type=equipment`);
    if(!r.ok) return;
    categories = await r.json();
    categories.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id; opt.textContent = c.name;
      select.appendChild(opt.cloneNode(true));
      editSelect.appendChild(opt);
    });
  }catch(e){ /* noop */ }
}

async function loadMachines(){
  const list = document.getElementById("list");
  list.textContent = "Loading…";
  try{
    const r = await fetch(`${API}/machines/`, { headers: authHeaders() });
    if (!r.ok) { list.textContent = "Failed to load machines."; return; }
    allMachines = await r.json();
    renderList(allMachines);
  }catch(e){
    list.textContent = "Error loading machines.";
  }
}

function renderList(data) {
  const list = document.getElementById("list");
  if (!data.length) { list.innerHTML = "<p>No machines yet.</p>"; return; }

  const table = document.createElement("table");
  table.style.width="100%"; table.style.borderCollapse="collapse";
  table.innerHTML = `
    <thead>
      <tr>
        <th style="text-align:left">Category</th>
        <th style="text-align:left">Make</th>
        <th style="text-align:left">Model</th>
        <th>Year</th>
        <th>Width (m)</th>
        <th>Power (hp)</th>
        <th>Status</th>
        <th style="text-align:right"></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  data.forEach(m => {
    const catName = (categories.find(c => c.id === m.category_id)?.name) || "—";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(catName)}</td>
      <td>${esc(m.make)}</td>
      <td>${esc(m.model)}</td>
      <td style="text-align:center">${m.year ?? "—"}</td>
      <td style="text-align:center">${m.working_width_m ?? "—"}</td>
      <td style="text-align:center">${m.power_hp ?? "—"}</td>
      <td style="text-align:center">${statusChip(m.status)}</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="btn btn-outline" onclick='openEdit(${JSON.stringify(m)})'>Edit</button>
        <button class="btn btn-outline" onclick='quickStatus("${m.id}", "${m.status || "active"}")'>Status…</button>
        <button class="btn btn-outline" onclick='removeMachine("${m.id}")'>Delete</button>
      </td>
    `;

    // expandable details row
    const details = document.createElement("tr");
    details.innerHTML = `
      <td colspan="8" style="background:#fafafa;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.5rem;font-size:.95rem;padding:.5rem;">
          <div><strong>Serial:</strong> ${esc(m.serial_no) || "—"}</div>
          <div><strong>Power kW:</strong> ${m.power_kw ?? "—"}</div>
          <div><strong>Capacity/h:</strong> ${m.capacity_per_hour ?? "—"}</div>
          <div><strong>PTO hp:</strong> ${m.pto_hp ?? "—"}</div>
          <div><strong>Transport width:</strong> ${m.transport_width_m ?? "—"}</div>
          <div><strong>Tire size:</strong> ${esc(m.tire_size) || "—"}</div>
          <div><strong>Fuel:</strong> ${esc(m.fuel_type) || "—"}</div>
          <div><strong>Hours meter:</strong> ${m.hours_meter ?? "—"}</div>
          <div><strong>Road legal:</strong> ${fmtBool(m.is_road_legal)}</div>
          <div><strong>Telemetry:</strong> ${fmtBool(m.telemetry_enabled)}</div>
          <div style="grid-column:1/-1;"><strong>Notes:</strong> ${esc(m.notes) || "—"}</div>
        </div>
      </td>
    `;

    tbody.appendChild(tr);
    tbody.appendChild(details);
  });

  list.innerHTML = "";
  list.appendChild(table);
}

function statusChip(s) {
  const color = s === "active" ? "#12a150" : (s === "paused" ? "#b88900" : "#888");
  return `<span style="display:inline-block;padding:.1rem .5rem;border-radius:999px;background:${color}20;color:${color};">${esc(s)}</span>`;
}
function fmtBool(v){ return v===true?"Yes":v===false?"No":"—"; }

function filterList() {
  const q = document.getElementById("q").value.toLowerCase().trim();
  const status = document.getElementById("statusFilter").value;
  let rows = allMachines.slice();
  if (q) rows = rows.filter(m => (`${m.make} ${m.model} ${m.serial_no||""}`).toLowerCase().includes(q));
  if (status) rows = rows.filter(m => m.status === status);
  renderList(rows);
}

async function createMachine(e){
  e.preventDefault();
  const f = e.target;
  const payload = {
    category_id: f.category_id.value || null,
    make: f.make.value.trim(),
    model: f.model.value.trim(),
    year: numOrNull(f.year.value),
    serial_no: strOrNull(f.serial_no.value),
    power_hp: numOrNull(f.power_hp.value),
    power_kw: numOrNull(f.power_kw.value),
    working_width_m: numOrNull(f.working_width_m.value),
    capacity_per_hour: numOrNull(f.capacity_per_hour.value),
    pto_hp: numOrNull(f.pto_hp.value),
    is_road_legal: boolTri(f.is_road_legal.value),
    transport_width_m: numOrNull(f.transport_width_m.value),
    tire_size: strOrNull(f.tire_size.value),
    fuel_type: strOrNull(f.fuel_type.value),
    hours_meter: numOrNull(f.hours_meter.value),
    telemetry_enabled: boolTri(f.telemetry_enabled.value),
    notes: strOrNull(f.notes.value)
  };
  const r = await fetch(`${API}/machines/`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Create failed"); return false; }
  msgOk("Machine created.");
  f.reset();
  await loadMachines();
  return false;
}

function openEdit(m){
  editingId = m.id;
  const dlg = document.getElementById("editDlg");
  // categories
  const sel = document.getElementById("edit_category_id");
  sel.innerHTML = `<option value="">—</option>`;
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id; opt.textContent = c.name;
    if (c.id === m.category_id) opt.selected = true;
    sel.appendChild(opt);
  });

  setVal("edit_make", m.make);
  setVal("edit_model", m.model);
  setVal("edit_year", m.year);
  setVal("edit_serial_no", m.serial_no);
  setVal("edit_power_hp", m.power_hp);
  setVal("edit_power_kw", m.power_kw);
  setVal("edit_working_width_m", m.working_width_m);
  setVal("edit_capacity_per_hour", m.capacity_per_hour);
  setVal("edit_pto_hp", m.pto_hp);
  setVal("edit_transport_width_m", m.transport_width_m);
  setVal("edit_tire_size", m.tire_size);
  setVal("edit_fuel_type", m.fuel_type);
  setVal("edit_hours_meter", m.hours_meter);
  setSelect("edit_is_road_legal", m.is_road_legal);
  setSelect("edit_telemetry_enabled", m.telemetry_enabled);
  setVal("edit_status", m.status || "active");
  setVal("edit_notes", m.notes);

  dlg.showModal();
}
function closeEdit(){ document.getElementById("editDlg").close(); editingId = null; }

async function submitEdit(){
  if(!editingId) return;
  const payload = {
    category_id: valOrNull("edit_category_id"),
    make: strOrNull(get("edit_make").value),
    model: strOrNull(get("edit_model").value),
    year: numOrNull(get("edit_year").value),
    serial_no: strOrNull(get("edit_serial_no").value),
    power_hp: numOrNull(get("edit_power_hp").value),
    power_kw: numOrNull(get("edit_power_kw").value),
    working_width_m: numOrNull(get("edit_working_width_m").value),
    capacity_per_hour: numOrNull(get("edit_capacity_per_hour").value),
    pto_hp: numOrNull(get("edit_pto_hp").value),
    is_road_legal: boolTri(get("edit_is_road_legal").value),
    transport_width_m: numOrNull(get("edit_transport_width_m").value),
    tire_size: strOrNull(get("edit_tire_size").value),
    fuel_type: strOrNull(get("edit_fuel_type").value),
    hours_meter: numOrNull(get("edit_hours_meter").value),
    telemetry_enabled: boolTri(get("edit_telemetry_enabled").value),
    status: strOrNull(get("edit_status").value),
    notes: strOrNull(get("edit_notes").value)
  };
  const r = await fetch(`${API}/machines/${editingId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Update failed"); return; }
  msgOk("Machine updated.");
  closeEdit();
  await loadMachines();
}

async function quickStatus(id, current="active"){
  const s = prompt("Set status (active|paused|retired):", current);
  if(!s) return;
  const r = await fetch(`${API}/machines/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ status: s })
  });
  if(!r.ok){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Update failed"); return; }
  msgOk("Status updated.");
  await loadMachines();
}

async function removeMachine(id){
  if(!confirm("Delete this machine?")) return;
  const r = await fetch(`${API}/machines/${id}`, { method: "DELETE", headers: authHeaders() });
  if(r.status !== 204){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Delete failed"); return; }
  msgOk("Machine deleted.");
  await loadMachines();
}

/* ---- helpers ---- */
function get(id){ return document.getElementById(id); }
function setVal(id, v){ const el=get(id); if(!el) return; el.value = v ?? ""; }
function setSelect(id, v){
  const el=get(id); if(!el) return;
  if (v === true) el.value = "true";
  else if (v === false) el.value = "false";
  else el.value = "";
}
function valOrNull(id){ const v = get(id).value; return v ? v : null; }
function numOrNull(v){ return v ? Number(v) : null; }
function strOrNull(v){ v = (v ?? "").trim(); return v ? v : null; }
function boolTri(v){ return v===""?null:(v==="true"); }

/* hp -> kW helper (approx 1 hp = 0.7457 kW) */
function syncKW(hpInput, kwName){
  const hp = Number(hpInput.value);
  const out = document.querySelector(`[name="${kwName}"], #${kwName}`);
  if(!out) return;
  if(!isNaN(hp) && hp > 0) out.value = (hp * 0.7457).toFixed(2);
}
</script>
{% endblock %}
