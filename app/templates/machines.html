{% extends "base.html" %}
{% block content %}
<h2>My Machines</h2>

<!-- Gate for unauthenticated / non-provider users -->
<div id="gate" class="card" hidden>
  <p>You must be logged in as a <strong>provider</strong> to manage machines.</p>
  <p>
    <a class="btn" href="/login">Login</a>
    <a class="btn btn-outline" href="/dashboard">Go to dashboard</a>
  </p>
</div>

<!-- Main content -->
<section id="content" hidden>
  <!-- Create -->
  <div class="card">
    <h3>Add a machine</h3>
    <form id="createForm" class="form" onsubmit="return createMachine(event)">
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
        <label>Category
          <select name="category_id" id="categorySelect">
            <option value="">—</option>
          </select>
        </label>
        <label>Make
          <input name="make" required />
        </label>
        <label>Model
          <input name="model" required />
        </label>
        <label>Year
          <input name="year" type="number" min="1950" max="2100" />
        </label>
        <label>Working width (m)
          <input name="working_width_m" type="number" step="0.01" />
        </label>
        <label>Power (hp)
          <input name="power_hp" type="number" step="0.01" />
        </label>
        <label>Road legal
          <select name="is_road_legal">
            <option value="">—</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </label>
      </div>
      <label>Notes
        <textarea name="notes" rows="2" placeholder="Optional: attachments, configurations, etc."></textarea>
      </label>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <button class="btn" type="submit">Create machine</button>
        <button class="btn btn-outline" type="button" onclick="loadMachines()">Refresh</button>
      </div>
    </form>
  </div>

  <!-- List -->
  <div class="card" style="margin-top:1rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;">Your machines</h3>
      <div style="display:flex;gap:.5rem;">
        <input id="q" placeholder="Search make/model…" oninput="filterList()" />
        <select id="statusFilter" onchange="filterList()">
          <option value="">All statuses</option>
          <option value="active">Active</option>
          <option value="paused">Paused</option>
          <option value="retired">Retired</option>
        </select>
      </div>
    </div>
    <div id="list" style="margin-top:.5rem;"></div>
  </div>
</section>

<div id="msg" class="result" hidden></div>

<!-- Edit modal -->
<dialog id="editDlg" class="card" style="max-width:720px;width:95%;">
  <form method="dialog" style="margin:0" onsubmit="return false;">
    <h3>Edit machine</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
      <label>Category
        <select id="edit_category_id"></select>
      </label>
      <label>Make
        <input id="edit_make" required />
      </label>
      <label>Model
        <input id="edit_model" required />
      </label>
      <label>Year
        <input id="edit_year" type="number" min="1950" max="2100" />
      </label>
      <label>Working width (m)
        <input id="edit_working_width_m" type="number" step="0.01" />
      </label>
      <label>Power (hp)
        <input id="edit_power_hp" type="number" step="0.01" />
      </label>
      <label>Road legal
        <select id="edit_is_road_legal">
          <option value="">—</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </label>
      <label>Status
        <select id="edit_status" required>
          <option value="active">active</option>
          <option value="paused">paused</option>
          <option value="retired">retired</option>
        </select>
      </label>
    </div>
    <label>Notes
      <textarea id="edit_notes" rows="2"></textarea>
    </label>

    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem;">
      <button class="btn btn-outline" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="submitEdit()">Save</button>
    </div>
  </form>
</dialog>

<script>
const API = "/api/v1";
let token = localStorage.getItem("token");
let allMachines = [];
let categories = [];
let editingId = null;

function authHeaders() {
  return token ? { "Authorization": "Bearer " + token } : {};
}
function show(el, yes=true){ el.hidden = !yes; }
function msgOk(t){ const m = document.getElementById("msg"); m.className="result ok"; m.hidden=false; m.textContent=t; }
function msgErr(t){ const m = document.getElementById("msg"); m.className="result error"; m.hidden=false; m.textContent=t; }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

(async function init() {
  // gate by auth + role
  if (!token) return show(document.getElementById("gate"), true);
  try {
    const meRes = await fetch(`${API}/auth/me`, { headers: authHeaders() });
    if (!meRes.ok) throw 0;
    const me = await meRes.json();
    if (!me.is_provider) return show(document.getElementById("gate"), true);
    show(document.getElementById("content"), true);
  } catch { return show(document.getElementById("gate"), true); }

  await loadCategories();
  await loadMachines();
})();

async function loadCategories() {
  const select = document.getElementById("categorySelect");
  const editSelect = document.getElementById("edit_category_id");
  [select, editSelect].forEach(s => s.innerHTML = `<option value="">—</option>`);

  try{
    const r = await fetch(`${API}/categories?type=equipment`);
    if (!r.ok) return;
    categories = await r.json();
    categories.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id; opt.textContent = c.name;
      select.appendChild(opt.cloneNode(true));
      editSelect.appendChild(opt);
    });
  }catch(e){ /* noop */ }
}

async function loadMachines() {
  const list = document.getElementById("list");
  list.textContent = "Loading…";
  try{
    const r = await fetch(`${API}/machines/`, { headers: authHeaders() });
    if (!r.ok) { list.textContent = "Failed to load machines."; return; }
    allMachines = await r.json();
    renderList(allMachines);
  }catch(e){
    list.textContent = "Error loading machines.";
  }
}

function renderList(data) {
  const list = document.getElementById("list");
  if (!data.length) { list.innerHTML = "<p>No machines yet.</p>"; return; }

  const table = document.createElement("table");
  table.style.width="100%"; table.style.borderCollapse="collapse";
  table.innerHTML = `
    <thead>
      <tr>
        <th style="text-align:left">Category</th>
        <th style="text-align:left">Make</th>
        <th style="text-align:left">Model</th>
        <th>Year</th>
        <th>Width (m)</th>
        <th>Power (hp)</th>
        <th>Status</th>
        <th style="text-align:right"></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  data.forEach(m => {
    const tr = document.createElement("tr");
    const catName = (categories.find(c => c.id === m.category_id)?.name) || "—";
    tr.innerHTML = `
      <td>${esc(catName)}</td>
      <td>${esc(m.make)}</td>
      <td>${esc(m.model)}</td>
      <td style="text-align:center">${m.year ?? "—"}</td>
      <td style="text-align:center">${m.working_width_m ?? "—"}</td>
      <td style="text-align:center">${m.power_hp ?? "—"}</td>
      <td style="text-align:center">${statusChip(m.status)}</td>
      <td style="text-align:right; white-space:nowrap;">
        <button class="btn btn-outline" onclick='openEdit(${JSON.stringify(m)})'>Edit</button>
        <button class="btn btn-outline" onclick='quickStatus("${m.id}")'>Status…</button>
        <button class="btn btn-outline" onclick='removeMachine("${m.id}")'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  list.innerHTML = "";
  list.appendChild(table);
}

function statusChip(s) {
  const color = s === "active" ? "#12a150" : (s === "paused" ? "#b88900" : "#888");
  return `<span style="display:inline-block;padding:.1rem .5rem;border-radius:999px;background:${color}20;color:${color};">${esc(s)}</span>`;
}

function filterList() {
  const q = document.getElementById("q").value.toLowerCase().trim();
  const status = document.getElementById("statusFilter").value;
  let rows = allMachines.slice();
  if (q) rows = rows.filter(m => (`${m.make} ${m.model}`).toLowerCase().includes(q));
  if (status) rows = rows.filter(m => m.status === status);
  renderList(rows);
}

async function createMachine(e) {
  e.preventDefault();
  const f = e.target;
  const payload = {
    category_id: f.category_id.value || null,
    make: f.make.value.trim(),
    model: f.model.value.trim(),
    year: f.year.value ? Number(f.year.value) : null,
    working_width_m: f.working_width_m.value ? Number(f.working_width_m.value) : null,
    power_hp: f.power_hp.value ? Number(f.power_hp.value) : null,
    is_road_legal: f.is_road_legal.value === "" ? null : (f.is_road_legal.value === "true"),
    notes: f.notes.value || null
  };
  try{
    const r = await fetch(`${API}/machines/`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload)
    });
    if (!r.ok) { const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Create failed"); return false; }
    msgOk("Machine created.");
    f.reset();
    await loadMachines();
  }catch(e){ msgErr("Unexpected error."); }
  return false;
}

function openEdit(m) {
  editingId = m.id;
  const dlg = document.getElementById("editDlg");
  // populate categories
  const sel = document.getElementById("edit_category_id");
  sel.innerHTML = `<option value="">—</option>`;
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id; opt.textContent = c.name;
    if (c.id === m.category_id) opt.selected = true;
    sel.appendChild(opt);
  });

  document.getElementById("edit_make").value = m.make ?? "";
  document.getElementById("edit_model").value = m.model ?? "";
  document.getElementById("edit_year").value = m.year ?? "";
  document.getElementById("edit_working_width_m").value = m.working_width_m ?? "";
  document.getElementById("edit_power_hp").value = m.power_hp ?? "";
  document.getElementById("edit_is_road_legal").value = (m.is_road_legal === true ? "true" : m.is_road_legal === false ? "false" : "");
  document.getElementById("edit_status").value = m.status ?? "active";
  document.getElementById("edit_notes").value = m.notes ?? "";

  dlg.showModal();
}

function closeEdit(){ document.getElementById("editDlg").close(); editingId = null; }

async function submitEdit() {
  if (!editingId) return;
  const payload = {
    category_id: valOrNull("edit_category_id"),
    make: valOrTrim("edit_make"),
    model: valOrTrim("edit_model"),
    year: numOrNull("edit_year"),
    working_width_m: numOrNull("edit_working_width_m"),
    power_hp: numOrNull("edit_power_hp"),
    is_road_legal: boolOrNull("edit_is_road_legal"),
    status: valOrTrim("edit_status"),
    notes: valOrTrim("edit_notes") || null
  };
  try{
    const r = await fetch(`${API}/machines/${editingId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(payload)
    });
    if (!r.ok) { const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Update failed"); return; }
    msgOk("Machine updated.");
    closeEdit();
    await loadMachines();
  }catch(e){ msgErr("Unexpected error."); }
}

async function quickStatus(id) {
  const s = prompt("Set status (active|paused|retired):", "active");
  if (!s) return;
  await fetch(`${API}/machines/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify({ status: s })
  }).then(async r => {
    if (!r.ok) { const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Update failed"); return; }
    msgOk("Status updated.");
    loadMachines();
  }).catch(()=>msgErr("Unexpected error."));
}

async function removeMachine(id) {
  if (!confirm("Delete this machine?")) return;
  try{
    const r = await fetch(`${API}/machines/${id}`, { method: "DELETE", headers: authHeaders() });
    if (r.status !== 204) { const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Delete failed"); return; }
    msgOk("Machine deleted.");
    await loadMachines();
  }catch(e){ msgErr("Unexpected error."); }
}

function valOrTrim(id){ const v = document.getElementById(id).value; return v != null ? v.trim() : null; }
function valOrNull(id){ const v = document.getElementById(id).value; return v ? v : null; }
function numOrNull(id){ const v = document.getElementById(id).value; return v ? Number(v) : null; }
function boolOrNull(id){ const v = document.getElementById(id).value; return v===""?null:(v==="true"); }
</script>
{% endblock %}
