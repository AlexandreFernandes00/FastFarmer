{% extends "base.html" %}
{% block content %}
<h2>My Machines</h2>

<div id="gate" class="card" hidden>
  <p>You need to be logged in as a <strong>provider</strong>.</p>
  <p><a class="btn" href="/login">Go to Login</a></p>
</div>

<section id="content" hidden>
  <div class="card">
    <h3>Add a machine</h3>
    <form id="createForm" class="form" onsubmit="return createMachine(event)">
      <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem;">
        <label>Make
          <input name="make" required />
        </label>
        <label>Model
          <input name="model" required />
        </label>
        <label>Year
          <input name="year" type="number" min="1950" max="2100" />
        </label>
        <label>Working width (m)
          <input name="working_width_m" type="number" step="0.01" />
        </label>
        <label>Power (hp)
          <input name="power_hp" type="number" step="0.01" />
        </label>
        <label>Road legal
          <select name="is_road_legal">
            <option value="">—</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </label>
      </div>
      <label>Notes
        <textarea name="notes" rows="2"></textarea>
      </label>
      <button class="btn" type="submit">Create machine</button>
    </form>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h3>Your machines</h3>
    <div id="list"></div>
  </div>
</section>

<div id="msg" class="result" hidden></div>

<script>
const API = "/api/v1";
const token = localStorage.getItem("token");

function authHeaders() {
  return token ? { "Authorization": "Bearer " + token } : {};
}
function show(el, yes=true){ el.hidden=!yes; }
function msgOk(t){ const m=document.getElementById("msg"); m.className="result ok"; m.hidden=false; m.textContent=t; }
function msgErr(t){ const m=document.getElementById("msg"); m.className="result error"; m.hidden=false; m.textContent=t; }

(async function init(){
  if(!token){ show(document.getElementById("gate"), true); return; }
  // Check role
  try{
    const me = await (await fetch(`${API}/auth/me`, { headers: authHeaders() })).json();
    if(!me.is_provider){ show(document.getElementById("gate"), true); return; }
    show(document.getElementById("content"), true);
    await loadMachines();
  }catch(e){
    show(document.getElementById("gate"), true);
  }
})();

async function loadMachines(){
  const list = document.getElementById("list");
  list.innerHTML = "Loading…";
  const r = await fetch(`${API}/machines/`, { headers: authHeaders() });
  if(!r.ok){ list.textContent = "Failed to load machines."; return; }
  const data = await r.json();
  if(!data.length){ list.innerHTML = "<p>No machines yet.</p>"; return; }

  const table = document.createElement("table");
  table.style.width="100%"; table.style.borderCollapse="collapse";
  table.innerHTML = `
    <thead>
      <tr>
        <th style="text-align:left">Make</th>
        <th style="text-align:left">Model</th>
        <th>Year</th>
        <th>Width (m)</th>
        <th>Power (hp)</th>
        <th>Status</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");
  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(m.make)}</td>
      <td>${escapeHtml(m.model)}</td>
      <td style="text-align:center">${m.year ?? "—"}</td>
      <td style="text-align:center">${m.working_width_m ?? "—"}</td>
      <td style="text-align:center">${m.power_hp ?? "—"}</td>
      <td style="text-align:center">${m.status}</td>
      <td style="text-align:right">
        <button class="btn btn-outline" onclick='editMachine(${JSON.stringify(m)})'>Edit</button>
        <button class="btn btn-outline" onclick='removeMachine("${m.id}")'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  list.innerHTML = "";
  list.appendChild(table);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function createMachine(e){
  e.preventDefault();
  const f = e.target;
  const payload = {
    make: f.make.value.trim(),
    model: f.model.value.trim(),
    year: f.year.value ? Number(f.year.value) : null,
    working_width_m: f.working_width_m.value ? Number(f.working_width_m.value) : null,
    power_hp: f.power_hp.value ? Number(f.power_hp.value) : null,
    is_road_legal: f.is_road_legal.value === "" ? null : (f.is_road_legal.value === "true"),
    notes: f.notes.value || null
  };
  const r = await fetch(`${API}/machines/`, {
    method: "POST",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Create failed"); return false; }
  msgOk("Machine created.");
  f.reset();
  await loadMachines();
  return false;
}

function editMachine(m){
  // very simple inline prompt-based edit (MVP). You can replace with a proper modal later.
  const newStatus = prompt("Set status (active|paused|retired):", m.status || "active");
  if(!newStatus) return;
  updateMachine(m.id, { status: newStatus });
}

async function updateMachine(id, patch){
  const r = await fetch(`${API}/machines/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...authHeaders() },
    body: JSON.stringify(patch)
  });
  if(!r.ok){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Update failed"); return; }
  msgOk("Machine updated.");
  await loadMachines();
}

async function removeMachine(id){
  if(!confirm("Delete this machine?")) return;
  const r = await fetch(`${API}/machines/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  });
  if(r.status !== 204){ const err = await r.json().catch(()=>({detail:"Error"})); msgErr(err.detail || "Delete failed"); return; }
  msgOk("Machine deleted.");
  await loadMachines();
}
</script>
{% endblock %}
