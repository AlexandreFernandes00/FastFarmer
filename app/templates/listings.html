{% extends "base.html" %}
{% block title %}Listings & Pricing · FastFarmer{% endblock %}
{% block content %}

<h2>My Listings & Pricing</h2>
<p style="color:#475569;margin-top:-.2rem">Manage your listings and their pricing rules. Pricing is attached to a listing (no machine fallback).</p>

<div id="msg" class="result" hidden></div>

<!-- Listings grid -->
<div id="listingsGrid" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:1rem; margin-top:1rem;">
  <div class="card"><p>Loading your listings…</p></div>
</div>

<!-- Pricing Editor Modal -->
<dialog id="pricingDlg" class="card" style="max-width:720px; width:96%;">
  <form id="pricingForm" method="dialog" onsubmit="return false;" style="margin:0;">
    <h3 id="pricingDlgTitle">Add pricing</h3>
    <p id="pricingDlgSub" style="margin-top:-.25rem; color:#555;"></p>

    <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:.75rem; margin-top:.5rem;">
      <label>Listing
        <select id="pf_listing_id" required></select>
      </label>
      <label>Unit
        <select id="pf_unit" required>
          <option value="hour">hour</option>
          <option value="day">day</option>
          <option value="hectare">hectare</option>
          <option value="km">km</option>
          <option value="job">job</option>
        </select>
      </label>
      <label>Base price
        <input id="pf_base_price" type="number" step="0.01" min="0" placeholder="e.g. 120" required/>
      </label>
      <label>Min qty
        <input id="pf_min_qty" type="number" step="0.01" min="0" placeholder="optional"/>
      </label>
      <label>Transport flat fee
        <input id="pf_transport_flat_fee" type="number" step="0.01" min="0" placeholder="optional"/>
      </label>
      <label>Transport per km
        <input id="pf_transport_per_km" type="number" step="0.01" min="0" placeholder="optional"/>
      </label>
      <label>Currency
        <input id="pf_currency" maxlength="3" placeholder="EUR" />
      </label>
      <label style="grid-column: 1 / -1;">Surcharges (JSON)
        <textarea id="pf_surcharges" rows="3" placeholder='e.g. {"night":1.2,"weekend":1.15}'></textarea>
      </label>
    </div>

    <div class="result error" id="pricingErr" hidden style="margin-top:.6rem;"></div>

    <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem;">
      <button class="btn btn-outline" onclick="PR_close()">Cancel</button>
      <button class="btn" id="pf_saveBtn" onclick="PR_save()">Save</button>
    </div>
  </form>
</dialog>

{% endblock %}

{% block page_scripts %}
<script>
/* ================== Listings & Pricing (Provider) ================== */
const API = "/api/v1";
let token = localStorage.getItem("token");
function authHeaders(){ return token ? {"Authorization": "Bearer " + token} : {}; }
function esc(s){ return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function showMsg(type, text){
  const m = document.getElementById("msg");
  m.className = "result " + (type === "ok" ? "ok" : "error");
  m.hidden = false; m.textContent = text;
}

let myListings = [];             // provider listings
let pricingByListing = new Map();// listing_id -> [rules]
let editingRule = null;          // {id,...} when editing, null when creating

(async function boot(){
  if (!token) {
    showMsg("error", "You must be logged in as a provider to manage listings.");
    document.getElementById("listingsGrid").innerHTML = `<div class="card"><p>Please <a href="/login">login</a>.</p></div>`;
    return;
  }
  await loadListings();
  await loadAllPricing();
  renderListings();
})();

async function loadListings(){
  try{
    const r = await fetch(`${API}/listings/`, { headers: authHeaders() });
    if (!r.ok) throw new Error("Failed to load listings");
    myListings = await r.json();
  }catch(e){
    showMsg("error", e.message || "Could not load listings.");
    myListings = [];
  }
}

async function loadAllPricing(){
  pricingByListing = new Map();
  // fetch per listing to keep filters simple & enforce ownership on server
  for (const lst of myListings) {
    try {
      const url = new URL(`${location.origin}${API}/pricing`);
      url.searchParams.set("listing_id", lst.id);
      const r = await fetch(url, { headers: authHeaders() });
      const arr = r.ok ? await r.json() : [];
      pricingByListing.set(lst.id, arr);
    } catch {
      pricingByListing.set(lst.id, []);
    }
  }
}

function renderListings(){
  const grid = document.getElementById("listingsGrid");
  if (!myListings.length) {
    grid.innerHTML = `<div class="card"><p>No listings yet. Create one first.</p></div>`;
    return;
  }

  grid.innerHTML = myListings.map(lst => {
    const rules = pricingByListing.get(lst.id) || [];
    const rows = rules.length ? rules.map(r => PR_row(lst, r)).join("") : `<tr><td colspan="6" style="color:#64748b;">No pricing rules yet.</td></tr>`;
    return `
      <div class="card" style="display:flex; flex-direction:column; gap:.6rem;">
        <div>
          <div style="font-weight:700;">${esc(lst.title)}</div>
          <div style="color:#556;">${esc(lst.description || "")}</div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr auto; align-items:center;">
          <div style="font-weight:600; color:#334155;">Pricing rules</div>
          <button class="btn" onclick='PR_openCreate(${JSON.stringify(lst)})'>Add pricing</button>
        </div>

        <div style="overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:.4rem; border-bottom:1px solid #e5e7eb;">Unit</th>
                <th style="text-align:left; padding:.4rem; border-bottom:1px solid #e5e7eb;">Base price</th>
                <th style="text-align:left; padding:.4rem; border-bottom:1px solid #e5e7eb;">Min qty</th>
                <th style="text-align:left; padding:.4rem; border-bottom:1px solid #e5e7eb;">Transport</th>
                <th style="text-align:left; padding:.4rem; border-bottom:1px solid #e5e7eb;">Currency</th>
                <th style="text-align:right; padding:.4rem; border-bottom:1px solid #e5e7eb;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }).join("");
}

function PR_row(lst, r){
  const tparts = [];
  if (r.transport_flat_fee != null) tparts.push(`flat ${r.transport_flat_fee}`);
  if (r.transport_per_km != null) tparts.push(`${r.transport_per_km}/km`);
  const transport = tparts.length ? tparts.join(" + ") : "—";
  return `
    <tr>
      <td style="padding:.45rem .4rem;">${esc(r.unit)}</td>
      <td style="padding:.45rem .4rem;">${esc(r.base_price)}</td>
      <td style="padding:.45rem .4rem;">${r.min_qty != null ? esc(r.min_qty) : "—"}</td>
      <td style="padding:.45rem .4rem;">${esc(transport)}</td>
      <td style="padding:.45rem .4rem;">${esc(r.currency || "EUR")}</td>
      <td style="padding:.45rem .4rem; text-align:right;">
        <button class="btn btn-outline" onclick='PR_openEdit(${JSON.stringify(lst)}, ${JSON.stringify(r)})'>Edit</button>
        <button class="btn btn-outline" onclick='PR_delete("${r.id}", "${lst.id}")' style="margin-left:.4rem;">Delete</button>
      </td>
    </tr>
  `;
}

/* ---------------------- Modal logic ---------------------- */
function PR_fillListingOptions(selectedId){
  const sel = document.getElementById("pf_listing_id");
  sel.innerHTML = "";
  myListings.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.id;
    opt.textContent = l.title;
    if (selectedId && selectedId === l.id) opt.selected = true;
    sel.appendChild(opt);
  });
}

function PR_openCreate(listing){
  editingRule = null;
  document.getElementById("pricingDlgTitle").textContent = "Add pricing";
  document.getElementById("pricingDlgSub").textContent = listing ? listing.title : "";
  PR_fillListingOptions(listing?.id);
  document.getElementById("pf_unit").value = "hour";
  document.getElementById("pf_base_price").value = "";
  document.getElementById("pf_min_qty").value = "";
  document.getElementById("pf_transport_flat_fee").value = "";
  document.getElementById("pf_transport_per_km").value = "";
  document.getElementById("pf_currency").value = "EUR";
  document.getElementById("pf_surcharges").value = "";
  document.getElementById("pricingErr").hidden = true;
  document.getElementById("pricingDlg").showModal();
}

function PR_openEdit(listing, rule){
  editingRule = rule; // has id
  document.getElementById("pricingDlgTitle").textContent = "Edit pricing";
  document.getElementById("pricingDlgSub").textContent = listing ? listing.title : "";
  PR_fillListingOptions(rule.listing_id || listing?.id);
  document.getElementById("pf_unit").value = rule.unit || "hour";
  document.getElementById("pf_base_price").value = rule.base_price ?? "";
  document.getElementById("pf_min_qty").value = rule.min_qty ?? "";
  document.getElementById("pf_transport_flat_fee").value = rule.transport_flat_fee ?? "";
  document.getElementById("pf_transport_per_km").value = rule.transport_per_km ?? "";
  document.getElementById("pf_currency").value = rule.currency || "EUR";
  document.getElementById("pf_surcharges").value = rule.surcharges ? JSON.stringify(rule.surcharges, null, 2) : "";
  document.getElementById("pricingErr").hidden = true;
  document.getElementById("pricingDlg").showModal();
}

function PR_close(){ document.getElementById("pricingDlg").close(); }

/* Save (POST for create, PUT for edit) */
async function PR_save(){
  const err = document.getElementById("pricingErr");
  err.hidden = true; err.textContent = "";

  const listing_id = document.getElementById("pf_listing_id").value;
  const unit = document.getElementById("pf_unit").value;
  const base_price = parseFloat(document.getElementById("pf_base_price").value);
  const min_qty = document.getElementById("pf_min_qty").value ? parseFloat(document.getElementById("pf_min_qty").value) : null;
  const transport_flat_fee = document.getElementById("pf_transport_flat_fee").value ? parseFloat(document.getElementById("pf_transport_flat_fee").value) : null;
  const transport_per_km = document.getElementById("pf_transport_per_km").value ? parseFloat(document.getElementById("pf_transport_per_km").value) : null;
  const currency = (document.getElementById("pf_currency").value || "EUR").toUpperCase();
  const surchargesRaw = document.getElementById("pf_surcharges").value.trim();

  if (!listing_id || !unit || isNaN(base_price)) {
    err.hidden = false; err.textContent = "Listing, unit and base price are required.";
    return;
  }

  let surcharges = null;
  if (surchargesRaw) {
    try { surcharges = JSON.parse(surchargesRaw); }
    catch { err.hidden = false; err.textContent = "Surcharges must be valid JSON."; return; }
  }

  const payload = {
    listing_id, unit, base_price, min_qty,
    transport_flat_fee, transport_per_km, currency, surcharges
  };

  try{
    let r;
    if (editingRule && editingRule.id) {
      // Full replace (PUT) so all fields are saved
      r = await fetch(`${API}/pricing/${editingRule.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify(payload)
      });
    } else {
      r = await fetch(`${API}/pricing`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify(payload)
      });
    }
    if (!r.ok) {
      const e = await r.json().catch(()=>({detail:"Save failed"}));
      throw new Error(e.detail || "Save failed");
    }
    // Refresh pricing for affected listings (old & possibly new if listing moved)
    const affected = new Set();
    if (editingRule?.listing_id) affected.add(editingRule.listing_id);
    affected.add(listing_id);
    for (const lid of affected) {
      try{
        const url = new URL(`${location.origin}${API}/pricing`);
        url.searchParams.set("listing_id", lid);
        const pr = await fetch(url, { headers: authHeaders() });
        const arr = pr.ok ? await pr.json() : [];
        pricingByListing.set(lid, arr);
      }catch{}
    }
    renderListings();
    PR_close();
    showMsg("ok", "Pricing saved.");
  }catch(e){
    err.hidden = false; err.textContent = e.message || "Could not save.";
  }
}

async function PR_delete(id, listingId){
  if (!confirm("Delete this pricing rule?")) return;
  try{
    const r = await fetch(`${API}/pricing/${id}`, {
      method: "DELETE",
      headers: authHeaders()
    });
    if (!r.ok) throw new Error("Delete failed");
    // refresh that listing's pricing
    const url = new URL(`${location.origin}${API}/pricing`);
    url.searchParams.set("listing_id", listingId);
    const pr = await fetch(url, { headers: authHeaders() });
    const arr = pr.ok ? await pr.json() : [];
    pricingByListing.set(listingId, arr);
    renderListings();
    showMsg("ok", "Pricing deleted.");
  }catch(e){
    showMsg("error", e.message || "Could not delete.");
  }
}
</script>
{% endblock %}
